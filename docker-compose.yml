services:
  # Main development environment
  ml-odyssey-dev:
    user: "${USER_ID}:${GROUP_ID}"
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    image: ml-odyssey:dev
    volumes:
      - .:/workspace:delegated
      - /workspace/.pixi
      - pixi-cache:/home/dev/.pixi
      - pre-commit-cache:/home/dev/.cache/pre-commit
      - ${HOME}/.gitconfig:/home/dev/.gitconfig:ro
    environment:
      - USER_ID=${USER_ID}
      - GROUP_ID=${GROUP_ID}
      - ENVIRONMENT=development
      - TERM=xterm-256color
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: /bin/bash

  # CI/Testing environment
  ml-odyssey-ci:
    user: "${USER_ID}:${GROUP_ID}"
    build:
      context: .
      dockerfile: Dockerfile
      target: ci
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    image: ml-odyssey:ci
    volumes:
      - .:/workspace
    environment:
      - USER_ID=${USER_ID}
      - GROUP_ID=${GROUP_ID}
      - ENVIRONMENT=ci
      - CI=true
    working_dir: /workspace

  # Production environment
  ml-odyssey-prod:
    user: "${USER_ID}:${GROUP_ID}"
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        USER_ID: ${USER_ID}
        GROUP_ID: ${GROUP_ID}
    image: ml-odyssey:prod
    volumes:
      - .:/workspace:ro
    environment:
      - USER_ID=${USER_ID}
      - GROUP_ID=${GROUP_ID}
      - ENVIRONMENT=production
    working_dir: /workspace

volumes:
  pixi-cache:
    driver: local
  pre-commit-cache:
    driver: local
