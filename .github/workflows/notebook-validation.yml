name: Notebook Validation

on:
  pull_request:
    paths:
      - 'notebooks/**'
      - '.github/workflows/notebook-validation.yml'
  push:
    branches: [main]
    paths:
      - 'notebooks/**'

jobs:
  validate-notebooks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install nbformat nbconvert

      - name: Validate notebook syntax
        run: |
          echo "Validating notebook syntax..."
          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              echo "Checking: $notebook"
              python -m json.tool "$notebook" > /dev/null || exit 1
            fi
          done
          echo "✅ All notebooks have valid JSON"

      - name: Check for large notebooks
        run: |
          echo "Checking notebook sizes..."
          max_size=$((500 * 1024))  # 500KB in bytes
          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              size=$(stat -f%z "$notebook" 2>/dev/null || stat -c%s "$notebook")
              if [ "$size" -gt "$max_size" ]; then
                echo "❌ ERROR: $notebook exceeds 500KB (size: $((size / 1024))KB)"
                echo "   Please clear notebook outputs with: just jupyter-clear"
                exit 1
              fi
            fi
          done
          echo "✅ All notebooks under size limit"

      - name: Check notebook count
        run: |
          echo "Checking notebook inventory..."
          expected=6
          found=$(find notebooks -name "*.ipynb" -type f | wc -l)
          if [ "$found" -lt "$expected" ]; then
            echo "⚠️  Warning: Found $found notebooks, expected $expected"
          else
            echo "✅ Found $found notebooks"
          fi

      - name: Verify README
        run: |
          if [ ! -f "notebooks/README.md" ]; then
            echo "❌ ERROR: notebooks/README.md not found"
            exit 1
          fi
          echo "✅ notebooks/README.md exists"

      - name: Check utils package
        run: |
          echo "Checking notebooks/utils package..."
          if [ ! -f "notebooks/utils/__init__.py" ]; then
            echo "❌ ERROR: notebooks/utils/__init__.py not found"
            exit 1
          fi
          for module in mojo_bridge tensor_utils visualization progress; do
            if [ ! -f "notebooks/utils/${module}.py" ]; then
              echo "⚠️  Warning: notebooks/utils/${module}.py not found"
            fi
          done
          echo "✅ Utility modules present"

  lint-notebooks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Lint notebook markdown
        run: |
          echo "Checking notebook markdown..."
          # Check for common markdown issues
          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              # Extract markdown cells and check for common issues
              python3 -c "
          import json
          import sys
          with open('$notebook') as f:
              nb = json.load(f)
          for cell in nb['cells']:
              if cell['cell_type'] == 'markdown':
                  source = ''.join(cell['source'])
                  # Check for unclosed code blocks
                  if source.count('\`\`\`') % 2 != 0:
                      print(f'Warning: Unclosed code block in $notebook')
                      sys.exit(1)
          "
            fi
          done
          echo "✅ Notebook markdown looks good"

  python-syntax:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Lint utility modules
        run: |
          pip install pylint ruff
          echo "Linting utility modules..."
          python -m py_compile notebooks/utils/*.py
          echo "✅ Utility modules compile successfully"
