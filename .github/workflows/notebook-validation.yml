name: Notebook Validation

on:
  pull_request:
    paths:
      - 'notebooks/**'
      - '.github/workflows/notebook-validation.yml'
  push:
    branches: [main]
    paths:
      - 'notebooks/**'

jobs:
  validate-notebooks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install nbformat nbconvert

      - name: Validate notebook syntax
        run: |
          echo "Validating notebook syntax..."
          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              echo "Checking: $notebook"
              python -m json.tool "$notebook" > /dev/null || exit 1
            fi
          done
          echo "✅ All notebooks have valid JSON"

      - name: Check for large notebooks
        run: |
          echo "Checking notebook sizes..."
          max_size=$((500 * 1024))  # 500KB in bytes
          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              size=$(stat -f%z "$notebook" 2>/dev/null || stat -c%s "$notebook")
              if [ "$size" -gt "$max_size" ]; then
                echo "❌ ERROR: $notebook exceeds 500KB (size: $((size / 1024))KB)"
                echo "   Please clear notebook outputs with: just jupyter-clear"
                exit 1
              fi
            fi
          done
          echo "✅ All notebooks under size limit"

      - name: Check notebook count
        run: |
          echo "Checking notebook inventory..."
          expected=6
          found=$(find notebooks -name "*.ipynb" -type f | wc -l)
          if [ "$found" -lt "$expected" ]; then
            echo "⚠️  Warning: Found $found notebooks, expected $expected"
          else
            echo "✅ Found $found notebooks"
          fi

      - name: Verify README
        run: |
          if [ ! -f "notebooks/README.md" ]; then
            echo "❌ ERROR: notebooks/README.md not found"
            exit 1
          fi
          echo "✅ notebooks/README.md exists"

      - name: Check utils package
        run: |
          echo "Checking notebooks/utils package..."
          if [ ! -f "notebooks/utils/__init__.py" ]; then
            echo "❌ ERROR: notebooks/utils/__init__.py not found"
            exit 1
          fi
          for module in mojo_bridge tensor_utils visualization progress; do
            if [ ! -f "notebooks/utils/${module}.py" ]; then
              echo "⚠️  Warning: notebooks/utils/${module}.py not found"
            fi
          done
          echo "✅ Utility modules present"

  lint-notebooks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Lint notebook markdown
        run: |
          echo "Checking notebook markdown..."
          # Check for common markdown issues
          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              # Extract markdown cells and check for common issues
              python3 << 'EOF'
import json
import sys

with open('$notebook') as f:
    nb = json.load(f)

for cell in nb['cells']:
    if cell['cell_type'] == 'markdown':
        source = ''.join(cell['source'])
        # Check for unclosed code blocks
        if source.count('```') % 2 != 0:
            print(f"⚠️  Unclosed code block in {notebook}")
            sys.exit(1)
EOF
            fi
          done
          echo "✅ Notebook markdown looks good"

  python-syntax:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check Python syntax in code cells
        run: |
          echo "Checking Python code in notebooks..."
          python3 << 'EOF'
import json
import py_compile
import tempfile
import os

error_count = 0
for notebook_path in ['notebooks/01_introduction.ipynb', 'notebooks/02_tensor_operations.ipynb']:
    if not os.path.exists(notebook_path):
        continue

    with open(notebook_path) as f:
        nb = json.load(f)

    for cell_idx, cell in enumerate(nb['cells']):
        if cell['cell_type'] == 'code':
            source = ''.join(cell['source'])
            if not source.strip():
                continue  # Skip empty cells

            # Try to compile the Python code
            try:
                compile(source, '<notebook>', 'exec')
            except SyntaxError as e:
                print(f"❌ Syntax error in {notebook_path}, cell {cell_idx + 1}")
                print(f"   {e}")
                error_count += 1

if error_count > 0:
    print(f"❌ Found {error_count} syntax errors")
    exit(1)
else:
    print("✅ All Python code has valid syntax")
EOF

      - name: Lint utility modules
        run: |
          pip install pylint ruff
          echo "Linting utility modules..."
          python -m py_compile notebooks/utils/*.py
          echo "✅ Utility modules compile successfully"
