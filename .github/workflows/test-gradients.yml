name: Gradient Checking Tests

on:
  pull_request:
    paths:
      - 'shared/core/**/*_backward.mojo'
      - 'shared/core/**/activation.mojo'
      - 'shared/core/**/arithmetic.mojo'
      - 'shared/training/**/*.mojo'
      - 'tests/shared/core/test_gradient_checking.mojo'
      - '.github/workflows/test-gradients.yml'
  push:
    branches:
      - main
    paths:
      - 'shared/core/**/*_backward.mojo'
      - 'shared/core/**/activation.mojo'
      - 'shared/core/**/arithmetic.mojo'
      - 'shared/training/**/*.mojo'
      - 'tests/shared/core/test_gradient_checking.mojo'

jobs:
  gradient-tests:
    name: Gradient Checking Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Mojo
        uses: modular/setup-mojo@v1
        with:
          mojo-version: '>=0.25.7'

      - name: Run gradient checking tests
        run: |
          mojo test tests/shared/core/test_gradient_checking.mojo

      - name: Check test results
        if: failure()
        run: |
          echo "âŒ Gradient checking tests FAILED!"
          echo "One or more backward passes produce incorrect gradients."
          echo "Review the test output above for details."
          exit 1

      - name: Success message
        if: success()
        run: |
          echo "âœ… All gradient checks PASSED!"
          echo "All backward passes produce correct gradients."

  gradient-coverage:
    name: Gradient Coverage Report
    runs-on: ubuntu-latest
    needs: gradient-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check backward pass coverage
        run: |
          echo "Checking gradient test coverage..."

          # Find all *_backward functions
          BACKWARD_FUNCS=$(grep -r "fn.*_backward" shared/core --include="*.mojo" | wc -l)

          # Find all gradient tests
          GRADIENT_TESTS=$(grep -r "test.*gradient" tests/shared/core/test_gradient_checking.mojo | wc -l)

          echo "Backward functions found: $BACKWARD_FUNCS"
          echo "Gradient tests found: $GRADIENT_TESTS"

          # Calculate coverage percentage
          if [ $BACKWARD_FUNCS -gt 0 ]; then
            COVERAGE=$((GRADIENT_TESTS * 100 / BACKWARD_FUNCS))
            echo "Gradient test coverage: $COVERAGE%"

            if [ $COVERAGE -lt 80 ]; then
              echo "âš ï¸  Warning: Gradient test coverage is below 80%"
              echo "Consider adding more gradient checking tests."
            else
              echo "âœ… Good gradient test coverage!"
            fi
          fi

  benchmark-simd:
    name: SIMD Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Mojo
        uses: modular/setup-mojo@v1
        with:
          mojo-version: '>=0.25.7'

      - name: Run SIMD benchmarks
        run: |
          echo "Running SIMD benchmarks..."
          mojo run benchmarks/bench_simd.mojo

      - name: Comment benchmark results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const comment = `## ðŸš€ SIMD Benchmark Results

            SIMD optimizations have been benchmarked. See the workflow logs for detailed results.

            Expected performance improvements:
            - float32 operations: 3-5x speedup
            - float64 operations: 2-3x speedup

            âœ… All SIMD operations verified for correctness against scalar implementations.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: issue_number,
              body: comment
            });
