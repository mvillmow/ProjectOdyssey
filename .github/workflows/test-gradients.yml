name: Gradient Checking Tests

on:
  pull_request:
    paths:
      - 'shared/core/**/*_backward.mojo'
      - 'shared/core/**/activation.mojo'
      - 'shared/core/**/arithmetic.mojo'
      - 'shared/training/**/*.mojo'
      - 'tests/shared/core/test_gradient_checking.mojo'
      - '.github/workflows/test-gradients.yml'
  push:
    branches:
      - main
    paths:
      - 'shared/core/**/*_backward.mojo'
      - 'shared/core/**/activation.mojo'
      - 'shared/core/**/arithmetic.mojo'
      - 'shared/training/**/*.mojo'
      - 'tests/shared/core/test_gradient_checking.mojo'

jobs:
  gradient-tests:
    name: Gradient Checking Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          cache: true

      - name: Run gradient checking tests
        run: |
          pixi run mojo -I . tests/shared/core/test_gradient_checking.mojo

      - name: Check test results
        if: failure()
        run: |
          echo "❌ Gradient checking tests FAILED!"
          echo "One or more backward passes produce incorrect gradients."
          echo "Review the test output above for details."
          exit 1

      - name: Success message
        if: success()
        run: |
          echo "✅ All gradient checks PASSED!"
          echo "All backward passes produce correct gradients."

  gradient-coverage:
    name: Gradient Coverage Report
    runs-on: ubuntu-latest
    needs: gradient-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Check backward pass coverage
        run: |
          echo "Checking gradient test coverage..."

          # Find all *_backward functions
          BACKWARD_FUNCS=$(grep -r "fn.*_backward" shared/core --include="*.mojo" | wc -l)

          # Find all gradient tests
          GRADIENT_TESTS=$(grep -r "test.*gradient" tests/shared/core/test_gradient_checking.mojo | wc -l)

          echo "Backward functions found: $BACKWARD_FUNCS"
          echo "Gradient tests found: $GRADIENT_TESTS"

          # Calculate coverage percentage
          if [ $BACKWARD_FUNCS -gt 0 ]; then
            COVERAGE=$((GRADIENT_TESTS * 100 / BACKWARD_FUNCS))
            echo "Gradient test coverage: $COVERAGE%"

            if [ $COVERAGE -lt 80 ]; then
              echo "⚠️  Warning: Gradient test coverage is below 80%"
              echo "Consider adding more gradient checking tests."
            else
              echo "✅ Good gradient test coverage!"
            fi
          fi
