name: Test Data Utilities

on:
  push:
    branches: [main]
    paths:
      - 'tests/shared/data/**'
      - 'shared/data/**'
      - '.github/workflows/test-data-utilities.yml'
  pull_request:
    branches: [main]
    paths:
      - 'tests/shared/data/**'
      - 'shared/data/**'
      - '.github/workflows/test-data-utilities.yml'

jobs:
  test-data-utilities:
    name: Data Utilities Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          cache: true

      - name: Verify Mojo installation
        run: |
          pixi run mojo --version

      - name: Check if test files exist
        id: check-tests
        run: |
          if [ -d "tests/shared/data" ]; then
            echo "tests_exist=true" >> $GITHUB_OUTPUT
          else
            echo "tests_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Dataset Tests
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: |
          echo "Running base dataset tests..."
          if [ -f "tests/shared/data/datasets/test_base_dataset.mojo" ]; then
            pixi run mojo -I . tests/shared/data/datasets/test_base_dataset.mojo
          fi

          echo "Running tensor dataset tests..."
          if [ -f "tests/shared/data/datasets/test_tensor_dataset.mojo" ]; then
            pixi run mojo -I . tests/shared/data/datasets/test_tensor_dataset.mojo
          fi

      - name: Run Loader Tests
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: |
          echo "Running base loader tests..."
          if [ -f "tests/shared/data/loaders/test_base_loader.mojo" ]; then
            pixi run mojo -I . tests/shared/data/loaders/test_base_loader.mojo
          fi

      - name: Run Transform Tests
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: |
          echo "Running transform pipeline tests..."
          if [ -f "tests/shared/data/transforms/test_pipeline.mojo" ]; then
            pixi run mojo -I . tests/shared/data/transforms/test_pipeline.mojo
          fi

      - name: Run Sampler Tests
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: |
          echo "Running sequential sampler tests..."
          if [ -f "tests/shared/data/samplers/test_sequential.mojo" ]; then
            pixi run mojo -I . tests/shared/data/samplers/test_sequential.mojo
          fi

      - name: Run All Data Tests
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: |
          echo "Running complete data utilities test suite..."
          if [ -f "tests/shared/data/run_all_tests.mojo" ]; then
            pixi run mojo -I . tests/shared/data/run_all_tests.mojo
          fi

      - name: Report Results
        if: always()
        run: |
          if [ "${{ steps.check-tests.outputs.tests_exist }}" = "true" ]; then
            echo "Data utilities test suite completed"
            echo "Check individual test outputs above for details"
          else
            echo "⚠️  Data utilities tests not yet implemented"
            echo "This workflow will run once tests/shared/data/ tests are created"
          fi
