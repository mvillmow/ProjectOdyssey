name: Comprehensive Mojo Tests

# Run ALL Mojo tests in the repository with comprehensive coverage
# Target duration: < 10 minutes (parallelized across test groups)

on:
  # Run on all pull requests
  pull_request:

  # Run on pushes to main
  push:
    branches:
      - main

  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # ============================================================================
  # Comprehensive Mojo Test Suite
  # ============================================================================
  test-mojo-comprehensive:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false  # Continue running other groups even if one fails
      matrix:
        test-group:
          - name: "Core: Tensors & Operations"
            path: "tests/shared/core"
            pattern: "test_tensors.mojo test_arithmetic*.mojo test_elementwise*.mojo test_matrix.mojo test_reduction*.mojo test_backward.mojo test_gradient_checking.mojo test_broadcasting.mojo test_comparison_ops.mojo test_creation.mojo test_properties.mojo"
          - name: "Core: Layers & Activations"
            path: "tests/shared/core"
            pattern: "test_layers.mojo test_activations.mojo test_advanced_activations.mojo test_dropout.mojo test_normalization.mojo test_losses.mojo"
          - name: "Core: Advanced Layers"
            path: "tests/shared/core"
            pattern: "test_conv.mojo test_pooling.mojo test_initializers*.mojo test_module.mojo test_shape*.mojo test_edge_cases.mojo test_utilities.mojo test_utility.mojo test_integration.mojo"
          - name: "Training: Optimizers & Schedulers"
            path: "tests/shared/training"
            pattern: "test_optimizers.mojo test_rmsprop.mojo test_*_scheduler.mojo"
          - name: "Training: Loops & Metrics"
            path: "tests/shared/training"
            pattern: "test_*_loop.mojo test_trainer_interface*.mojo test_metrics.mojo test_*_bugs.mojo test_numerical_safety.mojo"
          - name: "Training: Callbacks"
            path: "tests/shared/training"
            pattern: "test_callbacks.mojo test_checkpointing.mojo test_early_stopping.mojo test_logging_callback.mojo test_loops.mojo"
          - name: "Data: Datasets"
            path: "tests/shared/data"
            pattern: "test_datasets.mojo datasets/test_*.mojo"
          - name: "Data: Loaders & Samplers"
            path: "tests/shared/data"
            pattern: "test_loaders.mojo loaders/test_*.mojo samplers/test_*.mojo"
          - name: "Data: Transforms"
            path: "tests/shared/data"
            pattern: "test_transforms.mojo transforms/test_*.mojo"
          - name: "Integration Tests"
            path: "tests/shared/integration"
            pattern: "test_*.mojo"
          - name: "Utils & Fixtures"
            path: "tests/shared"
            pattern: "test_imports.mojo utils/test_*.mojo fixtures/test_*.mojo"
          - name: "Benchmarks"
            path: "tests/shared/benchmarks"
            pattern: "bench_*.mojo"
          - name: "Configs"
            path: "tests/configs"
            pattern: "test_*.mojo"
          - name: "Tooling"
            path: "tests/tooling/benchmarks"
            pattern: "test_*.mojo"
          - name: "Top-Level Tests"
            path: "tests"
            pattern: "test_*.mojo training/test_*.mojo unit/test_*.mojo"
          - name: "Debug & Integration"
            path: "tests"
            pattern: "debug/test_*.mojo integration/test_*.mojo"

    name: "${{ matrix.test-group.name }}"

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          cache: true

      - name: Cache Pixi environments
        uses: actions/cache@v4
        with:
          path: ~/.pixi
          key: pixi-${{ runner.os }}-${{ hashFiles('pixi.toml') }}
          restore-keys: |
            pixi-${{ runner.os }}-

      - name: Run test group
        run: |
          echo "=================================================="
          echo "Test Group: ${{ matrix.test-group.name }}"
          echo "Path: ${{ matrix.test-group.path }}"
          echo "=================================================="
          echo ""

          mkdir -p test-results

          test_count=0
          passed_count=0
          failed_count=0
          failed_tests=""

          # Save repository root for imports
          REPO_ROOT="$(pwd)"

          cd "${{ matrix.test-group.path }}" || exit 1

          # Expand pattern into actual files
          test_files=""
          for pattern in ${{ matrix.test-group.pattern }}; do
            # Check if pattern contains wildcards or is a direct path
            if [[ "$pattern" == *"*"* ]]; then
              # Glob pattern - expand it
              for file in $pattern; do
                if [ -f "$file" ]; then
                  test_files="$test_files $file"
                fi
              done
            else
              # Direct file or subdirectory pattern
              if [ -f "$pattern" ]; then
                test_files="$test_files $pattern"
              elif [[ "$pattern" == *"/"* ]]; then
                # Subdirectory pattern like "datasets/test_*.mojo"
                for file in $pattern; do
                  if [ -f "$file" ]; then
                    test_files="$test_files $file"
                  fi
                done
              fi
            fi
          done

          if [ -z "$test_files" ]; then
            echo "‚ö†Ô∏è  No test files found for this group"
            echo "This may be expected if tests haven't been created yet."
            echo "0 tests run, 0 failed" > ../../test-results/${{ matrix.test-group.name }}.txt
            exit 0
          fi

          # Run each test file
          for test_file in $test_files; do
            if [ -f "$test_file" ]; then
              echo ""
              echo "=================================================="
              echo "Running: $test_file"
              echo "=================================================="
              test_count=$((test_count + 1))

              if pixi run mojo -I "$REPO_ROOT" -I . "$test_file"; then
                echo "‚úÖ PASSED: $test_file"
                passed_count=$((passed_count + 1))
              else
                echo "‚ùå FAILED: $test_file"
                failed_count=$((failed_count + 1))
                failed_tests="$failed_tests\n  - $test_file"
              fi
            fi
          done

          echo ""
          echo "=================================================="
          echo "Test Group Summary: ${{ matrix.test-group.name }}"
          echo "=================================================="
          echo "Total: $test_count tests"
          echo "Passed: $passed_count tests"
          echo "Failed: $failed_count tests"
          echo ""

          # Save results
          result_file="../../../test-results/${{ matrix.test-group.name }}.txt"
          echo "Test Group: ${{ matrix.test-group.name }}" > "$result_file"
          echo "Total: $test_count tests run, $passed_count passed, $failed_count failed" >> "$result_file"
          if [ $failed_count -gt 0 ]; then
            echo "" >> "$result_file"
            echo "Failed tests:" >> "$result_file"
            echo -e "$failed_tests" >> "$result_file"
          fi

          if [ $failed_count -gt 0 ]; then
            exit 1
          fi
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results-${{ matrix.test-group.name }}
          path: test-results/
          retention-days: 7

  # ============================================================================
  # Combined Test Report
  # ============================================================================
  test-report:
    needs: test-mojo-comprehensive
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Download all test results
        uses: actions/download-artifact@v6
        with:
          path: all-test-results/
          pattern: test-results-*
          merge-multiple: true

      - name: Generate combined report
        run: |
          echo "# üß™ Comprehensive Mojo Test Results" > test-report.md
          echo "" >> test-report.md
          echo "**Workflow Run**: [\`${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> test-report.md
          echo "" >> test-report.md

          total_groups=0
          passed_groups=0
          failed_groups=0
          total_tests=0
          total_passed=0
          total_failed=0

          echo "## Test Groups" >> test-report.md
          echo "" >> test-report.md

          # Process each result file
          for result_file in all-test-results/*.txt; do
            if [ -f "$result_file" ]; then
              total_groups=$((total_groups + 1))
              group_name=$(basename "$result_file" .txt)

              echo "### $group_name" >> test-report.md

              # Extract test counts from result file
              if grep -q "failed" "$result_file"; then
                content=$(cat "$result_file")
                echo '```' >> test-report.md
                echo "$content" >> test-report.md
                echo '```' >> test-report.md

                # Parse counts (format: "Total: X tests run, Y passed, Z failed")
                if grep -q "Total:" "$result_file"; then
                  tests=$(grep "Total:" "$result_file" | grep -oP '\d+(?= tests run)' || echo "0")
                  passed=$(grep "Total:" "$result_file" | grep -oP '\d+(?= passed)' || echo "0")
                  failed=$(grep "Total:" "$result_file" | grep -oP '\d+(?= failed)' || echo "0")

                  total_tests=$((total_tests + tests))
                  total_passed=$((total_passed + passed))
                  total_failed=$((total_failed + failed))

                  if [ "$failed" -gt 0 ]; then
                    failed_groups=$((failed_groups + 1))
                  else
                    passed_groups=$((passed_groups + 1))
                  fi
                fi
              else
                cat "$result_file" >> test-report.md
              fi

              echo "" >> test-report.md
            fi
          done

          echo "## Summary" >> test-report.md
          echo "" >> test-report.md
          echo "- **Total Test Groups**: $total_groups" >> test-report.md
          echo "- **Passed Groups**: $passed_groups" >> test-report.md
          echo "- **Failed Groups**: $failed_groups" >> test-report.md
          echo "- **Total Tests**: $total_tests" >> test-report.md
          echo "- **Passed Tests**: $total_passed" >> test-report.md
          echo "- **Failed Tests**: $total_failed" >> test-report.md
          echo "" >> test-report.md

          if [ $total_failed -eq 0 ]; then
            echo "‚úÖ **All tests passed!**" >> test-report.md
          else
            echo "‚ùå **Some tests failed. See details above.**" >> test-report.md
          fi

          # Display report
          cat test-report.md

      - name: Upload combined report
        uses: actions/upload-artifact@v5
        with:
          name: comprehensive-test-report
          path: test-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('test-report.md', 'utf8');

              // Check if a comment already exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('üß™ Comprehensive Mojo Test Results')
              );

              const commentBody = report;

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
                console.log('Updated existing PR comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody
                });
                console.log('Created new PR comment');
              }
            } catch (error) {
              console.error('Failed to comment on PR:', error);
            }

      - name: Fail if any tests failed
        run: |
          # Check if any test groups failed
          failed=0
          for result_file in all-test-results/*.txt; do
            if [ -f "$result_file" ]; then
              if grep -q "failed" "$result_file"; then
                failed_count=$(grep "Total:" "$result_file" | grep -oP '\d+(?= failed)' || echo "0")
                if [ "$failed_count" -gt 0 ]; then
                  failed=1
                  break
                fi
              fi
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "‚ùå FAIL: Some tests failed. See test report for details."
            exit 1
          else
            echo "‚úÖ All tests passed!"
            exit 0
          fi
