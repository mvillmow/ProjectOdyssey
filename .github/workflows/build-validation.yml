name: Build Validation

# Validate builds and packaging
# Target duration: < 5 minutes

on:
  # Run on all pull requests
  pull_request:

  # Run on pushes to main
  push:
    branches:
      - main

  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # ============================================================================
  # Build Mojo Packages
  # ============================================================================
  build-mojo:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          cache: true

      - name: Cache Pixi environments
        uses: actions/cache@v4
        with:
          path: ~/.pixi
          key: pixi-${{ runner.os }}-${{ hashFiles('pixi.toml') }}
          restore-keys: |
            pixi-${{ runner.os }}-

      - name: Install Just
        uses: extractions/setup-just@v2

      - name: Build Mojo packages
        run: |
          echo "Building Mojo packages..."

          # Check if shared package exists
          if [ -d "shared" ]; then
            echo "Building shared package using justfile..."
            just ci-build
            echo "‚úÖ Shared package built successfully"
          else
            echo "‚ö†Ô∏è  No shared package found yet"
            echo "This is expected during initial development."
          fi

      - name: Run smoke tests
        run: |
          echo "Running Mojo smoke tests..."

          # Check if smoke tests exist
          if [ -d "tests/smoke" ]; then
            echo "Running smoke tests using justfile..."
            just ci-test-group "tests/smoke" "test_*.mojo" || true
          else
            echo "‚ö†Ô∏è  No smoke tests found yet (tests/smoke/)"
          fi

      - name: Create build artifacts
        run: |
          echo "Creating build artifacts..."
          mkdir -p build-artifacts/mojo

          # Copy compiled artifacts if they exist
          if [ -d "/tmp" ] && [ -n "$(find /tmp -name '*.o' -o -name '*.so' 2>/dev/null)" ]; then
            cp /tmp/*.o /tmp/*.so build-artifacts/mojo/ 2>/dev/null || true
          fi

          # Create build manifest
          echo "Build completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > build-artifacts/mojo/build-manifest.txt
          echo "Commit: ${{ github.sha }}" >> build-artifacts/mojo/build-manifest.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: mojo-build-artifacts
          path: build-artifacts/mojo/
          retention-days: 7

  # ============================================================================
  # Build Python Packages
  # ============================================================================
  build-python:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build Python packages
        run: |
          echo "Building Python packages..."

          # Check if pyproject.toml or setup.py exists
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "Building Python distribution..."
            python -m build

            # List built artifacts
            echo "Built artifacts:"
            ls -lh dist/

            echo "‚úÖ Python packages built successfully"
          else
            echo "‚ö†Ô∏è  No Python package configuration found (pyproject.toml or setup.py)"
            echo "This is expected during initial development."
            mkdir -p dist
            echo "No Python packages to build yet" > dist/README.txt
          fi

      - name: Validate package metadata
        run: |
          echo "Validating package metadata..."

          # Check if packages were built
          if [ -d "dist" ] && [ -n "$(ls -A dist/*.whl 2>/dev/null)" ]; then
            echo "Validating with twine..."
            twine check dist/*

            echo "‚úÖ Package metadata valid"
          else
            echo "‚ö†Ô∏è  No packages to validate"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: python-build-artifacts
          path: dist/
          retention-days: 7

  # ============================================================================
  # Build Documentation
  # ============================================================================
  build-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install documentation dependencies
        run: |
          pip install mkdocs mkdocs-material

      - name: Build documentation
        run: |
          echo "Building documentation..."

          # Check if mkdocs.yml exists
          if [ -f "mkdocs.yml" ]; then
            echo "Building MkDocs site..."
            mkdocs build --strict

            echo "‚úÖ Documentation built successfully"
          else
            echo "‚ö†Ô∏è  No mkdocs.yml found"
            echo "Documentation build will be configured later."
            mkdir -p site
            echo "<h1>Documentation Coming Soon</h1>" > site/index.html
          fi

      - name: Validate internal links
        run: |
          echo "Validating internal documentation links..."

          # Check if docs were built
          if [ -d "site" ]; then
            # Simple check for broken internal links
            echo "Basic link validation..."

            # Future: Use a proper link checker
            echo "‚úÖ Internal links validation (placeholder)"
          else
            echo "‚ö†Ô∏è  No documentation site to validate"
          fi

      - name: Upload docs artifacts
        uses: actions/upload-artifact@v5
        with:
          name: docs-build-artifacts
          path: site/
          retention-days: 7

  # ============================================================================
  # Build Validation
  # ============================================================================
  build-validation:
    needs: [build-mojo, build-python, build-docs]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: all-artifacts/

      - name: List all artifacts
        run: |
          echo "Downloaded artifacts:"
          find all-artifacts -type f

      - name: Run integration smoke test
        run: |
          echo "Running integration smoke tests..."

          # Check if all expected artifacts exist
          MOJO_ARTIFACTS=$(find all-artifacts/mojo-build-artifacts -type f 2>/dev/null | wc -l)
          PYTHON_ARTIFACTS=$(find all-artifacts/python-build-artifacts -type f 2>/dev/null | wc -l)
          DOCS_ARTIFACTS=$(find all-artifacts/docs-build-artifacts -type f 2>/dev/null | wc -l)

          echo "Mojo artifacts: $MOJO_ARTIFACTS files"
          echo "Python artifacts: $PYTHON_ARTIFACTS files"
          echo "Documentation artifacts: $DOCS_ARTIFACTS files"

          # Basic validation
          if [ "$MOJO_ARTIFACTS" -gt 0 ] || [ "$PYTHON_ARTIFACTS" -gt 0 ]; then
            echo "‚úÖ Build artifacts found"
          else
            echo "‚ö†Ô∏è  No build artifacts found (expected during initial development)"
          fi

      - name: Validate package compatibility
        run: |
          echo "Validating package compatibility..."

          # Future: Check for version compatibility, dependencies, etc.
          echo "‚úÖ Compatibility validation (placeholder)"

      - name: Generate build report
        run: |
          echo "# üèóÔ∏è Build Validation Results" > build-report.md
          echo "" >> build-report.md
          echo "**Workflow Run**: [\`${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> build-report.md
          echo "" >> build-report.md

          # Check build results
          echo "## Build Status" >> build-report.md
          echo "" >> build-report.md

          if [ "${{ needs.build-mojo.result }}" = "success" ]; then
            echo "- ‚úÖ **Mojo Build**: Passed" >> build-report.md
          else
            echo "- ‚ùå **Mojo Build**: Failed" >> build-report.md
          fi

          if [ "${{ needs.build-python.result }}" = "success" ]; then
            echo "- ‚úÖ **Python Build**: Passed" >> build-report.md
          else
            echo "- ‚ùå **Python Build**: Failed" >> build-report.md
          fi

          if [ "${{ needs.build-docs.result }}" = "success" ]; then
            echo "- ‚úÖ **Documentation Build**: Passed" >> build-report.md
          else
            echo "- ‚ùå **Documentation Build**: Failed" >> build-report.md
          fi

          echo "" >> build-report.md

          # Summary
          if [ "${{ needs.build-mojo.result }}" = "success" ] && \
             [ "${{ needs.build-python.result }}" = "success" ] && \
             [ "${{ needs.build-docs.result }}" = "success" ]; then
            echo "## Summary" >> build-report.md
            echo "" >> build-report.md
            echo "‚úÖ **All builds passed successfully!**" >> build-report.md
          else
            echo "## Summary" >> build-report.md
            echo "" >> build-report.md
            echo "‚ùå **Some builds failed. Please review the logs.**" >> build-report.md
          fi

          # Display report
          cat build-report.md

      - name: Upload build report
        uses: actions/upload-artifact@v5
        with:
          name: build-validation-report
          path: build-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('build-report.md', 'utf8');

              // Check if a comment already exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('üèóÔ∏è Build Validation Results')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: report
                });
                console.log('Updated existing PR comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
                console.log('Created new PR comment');
              }
            } catch (error) {
              console.error('Failed to comment on PR:', error);
            }

      - name: Check build status
        run: |
          # Fail if any build failed
          if [ "${{ needs.build-mojo.result }}" != "success" ] || \
             [ "${{ needs.build-python.result }}" != "success" ] || \
             [ "${{ needs.build-docs.result }}" != "success" ]; then
            echo "‚ùå Some builds failed"
            exit 1
          fi

          echo "‚úÖ All builds passed"
