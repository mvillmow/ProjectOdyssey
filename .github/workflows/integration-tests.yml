name: Integration Tests

# Run integration tests for component interactions
# Target duration: < 8 minutes

on:
  # Run on all pull requests (except drafts)
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

  # Run on pushes to main
  push:
    branches:
      - main

  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # ============================================================================
  # Integration Tests - Matrix Strategy
  # ============================================================================
  test-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Skip draft PRs
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'

    strategy:
      fail-fast: false  # Run all suites even if one fails
      matrix:
        test-suite:
          - agent-workflows
          - paper-pipeline
          - data-pipeline

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: latest
          cache: true

      - name: Cache Pixi environments
        uses: actions/cache@v4
        with:
          path: ~/.pixi
          key: pixi-${{ runner.os }}-${{ hashFiles('pixi.toml') }}
          restore-keys: |
            pixi-${{ runner.os }}-

      - name: Cache test data fixtures
        uses: actions/cache@v4
        with:
          path: tests/fixtures
          key: test-data-${{ hashFiles('tests/fixtures/**') }}
          restore-keys: |
            test-data-

      - name: Run integration test suite - ${{ matrix.test-suite }}
        run: |
          echo "Running integration tests for: ${{ matrix.test-suite }}"

          # Check if integration tests exist for this suite
          SUITE_PATH="tests/integration/${{ matrix.test-suite }}"

          if [ -d "$SUITE_PATH" ]; then
            # Check for Mojo tests
            if [ -n "$(find "$SUITE_PATH" -name '*.mojo' -o -name '*.üî•' 2>/dev/null)" ]; then
              echo "Running Mojo integration tests..."
              pixi run mojo test "$SUITE_PATH" --verbose
            fi

            # Check for Python tests
            if [ -n "$(find "$SUITE_PATH" -name 'test_*.py' 2>/dev/null)" ]; then
              echo "Running Python integration tests..."
              pixi run pytest "$SUITE_PATH" --verbose --maxfail=3 --timeout=180
            fi

            echo "‚úÖ Integration tests completed for ${{ matrix.test-suite }}"
          else
            echo "‚ö†Ô∏è  No integration tests found for ${{ matrix.test-suite }} yet"
            echo "Expected path: $SUITE_PATH"
            echo "This is expected during initial development."
            mkdir -p test-results
            echo "No tests found for ${{ matrix.test-suite }}" > test-results/${{ matrix.test-suite }}-results.txt
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-results-${{ matrix.test-suite }}
          path: test-results/
          retention-days: 7

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-failures-${{ matrix.test-suite }}
          path: |
            test-results/
            logs/
            *.log
          retention-days: 14

  # ============================================================================
  # Integration Test Report
  # ============================================================================
  integration-report:
    needs: test-integration
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: integration-results-*
          path: all-results/

      - name: Generate integration test report
        run: |
          echo "# üîó Integration Test Results" > integration-report.md
          echo "" >> integration-report.md
          echo "**Workflow Run**: [\`${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> integration-report.md
          echo "" >> integration-report.md

          # Count results
          TOTAL_SUITES=3
          PASSED_SUITES=0
          FAILED_SUITES=0

          # Check each test suite result
          for suite in agent-workflows paper-pipeline data-pipeline; do
            echo "## Test Suite: \`$suite\`" >> integration-report.md

            RESULT_DIR="all-results/integration-results-$suite"

            if [ -d "$RESULT_DIR" ]; then
              if grep -q "No tests found" "$RESULT_DIR"/*.txt 2>/dev/null; then
                echo "‚ö†Ô∏è  No tests implemented yet" >> integration-report.md
                PASSED_SUITES=$((PASSED_SUITES + 1))
              else
                echo "‚úÖ Tests passed" >> integration-report.md
                PASSED_SUITES=$((PASSED_SUITES + 1))
              fi
            else
              echo "‚ùå Tests failed or did not run" >> integration-report.md
              FAILED_SUITES=$((FAILED_SUITES + 1))
            fi

            echo "" >> integration-report.md
          done

          # Summary
          echo "## Summary" >> integration-report.md
          echo "" >> integration-report.md
          echo "- **Total Suites**: $TOTAL_SUITES" >> integration-report.md
          echo "- **Passed**: $PASSED_SUITES" >> integration-report.md
          echo "- **Failed**: $FAILED_SUITES" >> integration-report.md
          echo "" >> integration-report.md

          # Check for failures
          AGENT_RESULT="${{ needs.test-integration.result }}"
          if [ "$AGENT_RESULT" = "success" ]; then
            echo "‚úÖ **All integration tests passed!**" >> integration-report.md
          else
            echo "‚ùå **Some integration tests failed. Please review the logs.**" >> integration-report.md
          fi

          # Display report
          cat integration-report.md

      - name: Upload integration report
        uses: actions/upload-artifact@v4
        with:
          name: integration-report
          path: integration-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('integration-report.md', 'utf8');

              // Check if a comment already exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('üîó Integration Test Results')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: report
                });
                console.log('Updated existing PR comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
                console.log('Created new PR comment');
              }
            } catch (error) {
              console.error('Failed to comment on PR:', error);
            }

      - name: Check test results
        run: |
          # Fail if any test suite failed
          if [ "${{ needs.test-integration.result }}" != "success" ]; then
            echo "‚ùå Integration tests failed"
            exit 1
          fi

          echo "‚úÖ All integration tests passed"
