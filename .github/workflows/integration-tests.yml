name: Integration Tests

# Run integration tests for component interactions
# Target duration: < 8 minutes

on:
  # Run on all pull requests (except drafts)
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

  # Run on pushes to main
  push:
    branches:
      - main

  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # ============================================================================
  # Integration Tests - Matrix Strategy
  # ============================================================================
  test-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Skip draft PRs
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'

    strategy:
      fail-fast: false  # Run all suites even if one fails
      matrix:
        test-suite:
          - mojo-integration
          - python-integration
          - shared-integration

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          cache: true

      - name: Cache Pixi environments
        uses: actions/cache@v4
        with:
          path: ~/.pixi
          key: pixi-${{ runner.os }}-${{ hashFiles('pixi.toml') }}
          restore-keys: |
            pixi-${{ runner.os }}-

      - name: Cache test data fixtures
        uses: actions/cache@v4
        with:
          path: tests/fixtures
          key: test-data-${{ hashFiles('tests/fixtures/**') }}
          restore-keys: |
            test-data-

      - name: Run integration test suite - ${{ matrix.test-suite }}
        run: |
          # Set repository root for Mojo imports
          REPO_ROOT="$(pwd)"

          echo "Running integration tests for: ${{ matrix.test-suite }}"
          mkdir -p test-results

          # Map test suite to actual test paths
          case "${{ matrix.test-suite }}" in
            mojo-integration)
              echo "Running Mojo integration tests..."
              # Run tests/integration/*.mojo files
              if [ -d "tests/integration" ] && [ -n "$(find tests/integration -maxdepth 1 -name '*.mojo' -o -name '*.üî•' 2>/dev/null)" ]; then
                EXIT_CODE=0
                for file in tests/integration/*.mojo; do
                  if [ -f "$file" ]; then
                    echo "Running $file..."
                    pixi run mojo -I "$REPO_ROOT" -I . "$file" || EXIT_CODE=$?
                  fi
                done
                exit $EXIT_CODE
              else
                echo "‚ö†Ô∏è  No Mojo integration tests found in tests/integration/"
                echo "No Mojo integration tests found" > test-results/mojo-integration-results.txt
              fi
              ;;

            python-integration)
              echo "Running Python integration tests..."
              # Run Python integration tests (agents, foundation structure, etc.)
              TEST_FILES=""
              [ -f "tests/agents/test_integration.py" ] && TEST_FILES="$TEST_FILES tests/agents/test_integration.py"
              [ -f "tests/foundation/test_structure_integration.py" ] && TEST_FILES="$TEST_FILES tests/foundation/test_structure_integration.py"

              if [ -n "$TEST_FILES" ]; then
                pixi run python -m pytest $TEST_FILES --verbose --maxfail=3 --timeout=180
                echo "‚úÖ Python integration tests completed"
              else
                echo "‚ö†Ô∏è  No Python integration tests found"
                echo "No Python integration tests found" > test-results/python-integration-results.txt
              fi
              ;;

            shared-integration)
              echo "Running shared library integration tests..."
              # Run tests/shared/integration/*.mojo files
              if [ -d "tests/shared/integration" ] && [ -n "$(find tests/shared/integration -name '*.mojo' -o -name '*.üî•' 2>/dev/null)" ]; then
                EXIT_CODE=0
                for file in tests/shared/integration/*.mojo; do
                  if [ -f "$file" ]; then
                    echo "Running $file..."
                    pixi run mojo -I "$REPO_ROOT" -I . "$file" || EXIT_CODE=$?
                  fi
                done
                exit $EXIT_CODE
              else
                echo "‚ö†Ô∏è  No shared integration tests found in tests/shared/integration/"
                echo "No shared integration tests found" > test-results/shared-integration-results.txt
              fi
              ;;

            *)
              echo "‚ùå Unknown test suite: ${{ matrix.test-suite }}"
              exit 1
              ;;
          esac

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: integration-results-${{ matrix.test-suite }}
          path: test-results/
          retention-days: 7

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: integration-failures-${{ matrix.test-suite }}
          path: |
            test-results/
            logs/
            *.log
          retention-days: 14

  # ============================================================================
  # Integration Test Report
  # ============================================================================
  integration-report:
    needs: test-integration
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Download all test results
        uses: actions/download-artifact@v6
        with:
          pattern: integration-results-*
          path: all-results/

      - name: Generate integration test report
        run: |
          echo "# üîó Integration Test Results" > integration-report.md
          echo "" >> integration-report.md
          echo "**Workflow Run**: [\`${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> integration-report.md
          echo "" >> integration-report.md

          # Get the overall job result - this is the source of truth
          JOB_RESULT="${{ needs.test-integration.result }}"

          # Check each test suite for details
          for suite in mojo-integration python-integration shared-integration; do
            echo "## Test Suite: \`$suite\`" >> integration-report.md

            RESULT_DIR="all-results/integration-results-$suite"

            if [ -d "$RESULT_DIR" ]; then
              if grep -q "No.*integration tests found" "$RESULT_DIR"/*.txt 2>/dev/null; then
                echo "‚ö†Ô∏è  No tests implemented yet" >> integration-report.md
              else
                echo "‚úÖ Tests passed" >> integration-report.md
              fi
            else
              # No artifact directory - could be pass (no tests) or fail
              # Trust the job result for the actual status
              if [ "$JOB_RESULT" = "success" ]; then
                echo "‚ö†Ô∏è  No tests implemented yet" >> integration-report.md
              else
                echo "‚ùå Tests failed - check workflow logs for details" >> integration-report.md
              fi
            fi

            echo "" >> integration-report.md
          done

          # Summary based on job result (source of truth)
          echo "## Summary" >> integration-report.md
          echo "" >> integration-report.md

          if [ "$JOB_RESULT" = "success" ]; then
            echo "‚úÖ **All integration tests passed!**" >> integration-report.md
          elif [ "$JOB_RESULT" = "skipped" ]; then
            echo "‚è≠Ô∏è **Integration tests were skipped.**" >> integration-report.md
          else
            echo "‚ùå **Some integration tests failed. Please review the logs.**" >> integration-report.md
          fi

          # Display report
          cat integration-report.md

      - name: Upload integration report
        uses: actions/upload-artifact@v5
        with:
          name: integration-report
          path: integration-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('integration-report.md', 'utf8');

              // Check if a comment already exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('üîó Integration Test Results')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: report
                });
                console.log('Updated existing PR comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
                console.log('Created new PR comment');
              }
            } catch (error) {
              console.error('Failed to comment on PR:', error);
            }

      - name: Check test results
        run: |
          # Fail if any test suite failed
          if [ "${{ needs.test-integration.result }}" != "success" ]; then
            echo "‚ùå Integration tests failed"
            exit 1
          fi

          echo "‚úÖ All integration tests passed"
