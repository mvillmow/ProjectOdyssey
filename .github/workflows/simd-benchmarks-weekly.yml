name: Weekly SIMD Benchmarks

# Weekly benchmarks to track SIMD performance trends over time
# Runs every Sunday at 2 AM UTC

on:
  # Weekly schedule - Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual execution
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write  # For optional PR comments

jobs:
  simd-benchmarks:
    name: SIMD Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Only run on main branch for scheduled runs
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          cache: true

      - name: Cache Pixi environments
        uses: actions/cache@v4
        with:
          path: ~/.pixi
          key: pixi-${{ runner.os }}-${{ hashFiles('pixi.toml') }}
          restore-keys: |
            pixi-${{ runner.os }}-

      - name: Run SIMD benchmarks
        run: |
          echo "Running SIMD benchmarks..."
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Commit: ${{ github.sha }}"
          echo ""

          # Create results directory
          mkdir -p benchmark-results

          # Run the SIMD benchmark and capture output
          pixi run mojo run -I . benchmarks/bench_simd.mojo | tee benchmark-results/simd-output.txt

          # Check if benchmark succeeded
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "✅ SIMD benchmarks completed successfully"
          else
            echo "❌ SIMD benchmarks failed"
            exit 1
          fi

      - name: Generate benchmark summary
        if: success()
        run: |
          echo "Generating benchmark summary..."

          cat > benchmark-results/summary.md <<EOF
          # SIMD Performance Benchmark Results

          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit**: ${{ github.sha }}
          **Workflow Run**: [\`${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Results

          See \`simd-output.txt\` for full benchmark output.

          ## Benchmark Configuration

          - **Tensor Sizes**: 64x64, 128x128, 256x256, 512x512, 1024x1024
          - **Operations**: add, multiply (scalar vs SIMD)
          - **Data Types**: float32, float64
          - **Iterations**: 10 per operation

          ## Expected Performance

          - Float32 operations: 3-5x speedup
          - Float64 operations: 2-3x speedup
          - Larger tensors show better speedup (better amortization)

          ## Historical Tracking

          View previous benchmark results in workflow artifacts:
          ${{ github.server_url }}/${{ github.repository }}/actions/workflows/simd-benchmarks-weekly.yml
          EOF

          cat benchmark-results/summary.md

      - name: Extract performance metrics
        if: success()
        run: |
          echo "Extracting performance metrics..."

          # Create a JSON file with key metrics for trend tracking
          cat > benchmark-results/metrics.json <<EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}",
            "note": "Full metrics extraction to be implemented in future iterations"
          }
          EOF

          cat benchmark-results/metrics.json

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: simd-benchmark-results-${{ github.run_number }}
          path: benchmark-results/
          retention-days: 365  # Keep benchmark history for 1 year

      - name: Check for performance degradation
        if: success()
        run: |
          echo "Checking for performance degradation..."
          echo ""
          echo "⚠️  Automated performance regression detection not yet implemented"
          echo "Future enhancement: Compare against baseline from previous runs"
          echo ""
          echo "Manual review recommended:"
          echo "- Check SIMD speedup factors are within expected ranges"
          echo "- Compare against previous weekly benchmarks"
          echo "- Verify correctness checks all pass"

      - name: Success summary
        if: success()
        run: |
          echo "✅ Weekly SIMD benchmarks completed successfully!"
          echo ""
          echo "Results uploaded as artifact: simd-benchmark-results-${{ github.run_number }}"
          echo "Retention: 365 days"
          echo ""
          echo "View artifacts at:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
