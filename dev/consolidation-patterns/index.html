
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mojo-based AI research platform for reproducing classic research papers">
      
      
      
        <link rel="canonical" href="https://github.com/mvillmow/ProjectOdyssey/dev/consolidation-patterns/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Code Consolidation Patterns in ML Odyssey - ML Odyssey</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#code-consolidation-patterns-in-ml-odyssey" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ML Odyssey" class="md-header__button md-logo" aria-label="ML Odyssey" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ML Odyssey
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Code Consolidation Patterns in ML Odyssey
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mvillmow/ProjectOdyssey" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    mvillmow/ProjectOdyssey
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/installation/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../core/project-structure/" class="md-tabs__link">
          
  
  
  Core

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../advanced/performance/" class="md-tabs__link">
          
  
  
  Advanced

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../architecture/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../integration/supporting-directories/" class="md-tabs__link">
          
  
  
  Integration

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ML Odyssey" class="md-nav__button md-logo" aria-label="ML Odyssey" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ML Odyssey
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mvillmow/ProjectOdyssey" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    mvillmow/ProjectOdyssey
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/first_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    First Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/repository-structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repository Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/project-structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/shared-library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Shared Library
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/testing-strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing Strategy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/agent-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/mojo-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mojo Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/paper-implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Paper Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Advanced
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/custom-layers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Layers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/distributed-training/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distributed Training
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ci-cd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CI/CD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-process/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Release Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/supporting-directories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Supporting Directories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/papers-shared-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Papers & Shared Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../integration/quick-start-new-paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start New Paper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-gradient-result-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Gradient Result Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Gradient Result Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#purpose" class="md-nav__link">
    <span class="md-ellipsis">
      
        Purpose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#location" class="md-nav__link">
    <span class="md-ellipsis">
      
        Location
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#structure-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Structure Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-binary-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: Binary Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-linear-layer-backward" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: Linear Layer Backward
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Benefits
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-dtype-dispatch-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. DType Dispatch Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. DType Dispatch Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#purpose_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Purpose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reduction-in-code-size" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reduction in Code Size
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#location_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Location
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Concepts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supported-dtypes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Supported Dtypes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-unary-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: Unary Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-binary-operation_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: Binary Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-scalar-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: Scalar Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-float-only-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: Float-Only Operation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Benefits
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-constants-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Constants Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Constants Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#purpose_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Purpose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-organization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module Organization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Module Organization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#math-constants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Math Constants
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#numerical-constants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Numerical Constants
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-gelu-activation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: GELU Activation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example-numerical-stability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example: Numerical Stability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Benefits
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-utility-module-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Utility Module Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Utility Module Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#purpose_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Purpose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#location_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Location
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pattern-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pattern Structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-gradient-clipping-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example: Gradient Clipping Utilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-utility-modules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Utility Modules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-use_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Use
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Benefits
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-example-complete-backward-pass" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration Example: Complete Backward Pass
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary Table
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Documentation
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="code-consolidation-patterns-in-ml-odyssey">Code Consolidation Patterns in ML Odyssey</h1>
<p>This document describes the four primary consolidation patterns used across ML Odyssey to reduce code
duplication, improve maintainability, and enforce consistency.</p>
<h2 id="overview">Overview</h2>
<p>Consolidation patterns are recurring architectural solutions that centralize similar code into reusable
components. ML Odyssey implements four main patterns:</p>
<ol>
<li><strong>Gradient Result Pattern</strong> - Type-safe containers for multiple gradient returns</li>
<li><strong>DType Dispatch Pattern</strong> - Compile-time specialized operations with runtime dispatch</li>
<li><strong>Constants Pattern</strong> - Centralized mathematical and numerical constants</li>
<li><strong>Utility Module Pattern</strong> - Shared functionality for cross-cutting concerns</li>
</ol>
<h2 id="1-gradient-result-pattern">1. Gradient Result Pattern</h2>
<h3 id="purpose">Purpose</h3>
<p>Eliminates duplicate tuple-return structures for backward pass functions that compute gradients with
respect to multiple inputs. Instead of returning multiple gradients as separate values or tuples
(which have incomplete support in Mojo), use specialized container types.</p>
<h3 id="types">Types</h3>
<p><strong>GradientPair</strong> - For binary operations returning 2 gradients
<strong>GradientTriple</strong> - For ternary operations returning 3 gradients
<strong>GradientQuad</strong> - For quaternary operations returning 4 gradients</p>
<h3 id="location">Location</h3>
<p><code>shared/core/gradient_types.mojo</code></p>
<h3 id="structure-example">Structure Example</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">struct</span><span class="w"> </span><span class="n n-Struct">GradientPair</span><span class="p">(</span><span class="nb">Copyable</span><span class="p">,</span><span class="w"> </span><span class="nb">Movable</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Container for gradients from binary operations.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="s2">    Used for backward functions that compute gradients with respect to</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="s2">    two inputs (e.g., add_backward, multiply_backward).</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="s2">    Attributes:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="s2">        grad_a: Gradient with respect to first input.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="s2">        grad_b: Gradient with respect to second input.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_a</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_b</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_a</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_b</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">grad_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grad_a</span><span class="o">^</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">grad_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grad_b</span><span class="o">^</span>
</code></pre></div>
<h3 id="usage-example-binary-operation">Usage Example: Binary Operation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Without pattern (loses type information):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">fn</span><span class="w"> </span><span class="nf">add_backward</span><span class="p">(</span><span class="n">grad_output</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">shape_a</span><span class="p">:</span><span class="w"> </span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">],</span><span class="w"> </span><span class="n">shape_b</span><span class="p">:</span><span class="w"> </span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Tuple</span><span class="p">[</span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">]:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="c1"># ... compute gradients ...</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">grad_a</span><span class="p">,</span><span class="w"> </span><span class="n">grad_b</span><span class="p">)</span><span class="w">  </span><span class="c1"># Loses semantic meaning</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1"># With GradientPair pattern (clear intent):</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">fn</span><span class="w"> </span><span class="nf">add_backward</span><span class="p">(</span><span class="n">grad_output</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">shape_a</span><span class="p">:</span><span class="w"> </span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">],</span><span class="w"> </span><span class="n">shape_b</span><span class="p">:</span><span class="w"> </span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">GradientPair</span><span class="p">:</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="c1"># ... compute gradients ...</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GradientPair</span><span class="p">(</span><span class="n">grad_a</span><span class="p">,</span><span class="w"> </span><span class="n">grad_b</span><span class="p">)</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="c1"># Usage:</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="k">var</span><span class="w"> </span><span class="nv">grads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_backward</span><span class="p">(</span><span class="n">grad_output</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">(),</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="k">var</span><span class="w"> </span><span class="nv">grad_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grads</span><span class="o">.</span><span class="n">grad_a</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="k">var</span><span class="w"> </span><span class="nv">grad_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grads</span><span class="o">.</span><span class="n">grad_b</span>
</code></pre></div>
<h3 id="usage-example-linear-layer-backward">Usage Example: Linear Layer Backward</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Use GradientTriple for layer backward passes</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">fn</span><span class="w"> </span><span class="nf">linear_backward</span><span class="p">(</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="n">grad_output</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">weights</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">GradientTriple</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Compute gradients for linear layer.</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="s2">    Args:</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="s2">        grad_output: Gradient with respect to layer output.</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="s2">        x: Input activation tensor.</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="s2">        weights: Weight matrix.</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="s2">    Returns:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="s2">        GradientTriple containing:</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="s2">        - grad_input: Gradient with respect to input</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="s2">        - grad_weights: Gradient with respect to weights</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="s2">        - grad_bias: Gradient with respect to bias</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="c1"># Compute gradients</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_grad_input</span><span class="p">(</span><span class="n">grad_output</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_grad_weights</span><span class="p">(</span><span class="n">grad_output</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_bias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_grad_bias</span><span class="p">(</span><span class="n">grad_output</span><span class="p">)</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">GradientTriple</span><span class="p">(</span><span class="n">grad_input</span><span class="p">,</span><span class="w"> </span><span class="n">grad_weights</span><span class="p">,</span><span class="w"> </span><span class="n">grad_bias</span><span class="p">)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="c1"># Usage:</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="k">var</span><span class="w"> </span><span class="nv">grads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linear_backward</span><span class="p">(</span><span class="n">grad_out</span><span class="p">,</span><span class="w"> </span><span class="nb">input</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="k">var</span><span class="w"> </span><span class="nv">grad_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grads</span><span class="o">.</span><span class="n">grad_input</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="k">var</span><span class="w"> </span><span class="nv">grad_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grads</span><span class="o">.</span><span class="n">grad_weights</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="k">var</span><span class="w"> </span><span class="nv">grad_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grads</span><span class="o">.</span><span class="n">grad_bias</span>
</code></pre></div>
<h3 id="when-to-use">When to Use</h3>
<ul>
<li><strong>Use GradientPair</strong> for operations with exactly 2 inputs (add, sub, mul, div, pow, etc.)</li>
<li><strong>Use GradientTriple</strong> for layer backward passes (linear, conv2d, etc.) with input, weights, bias</li>
<li><strong>Use GradientQuad</strong> for operations with 4 inputs (reserved for future complex backward passes)</li>
<li><strong>Don't use</strong> Tuple returns for gradients - use one of these types instead</li>
</ul>
<h3 id="benefits">Benefits</h3>
<ul>
<li>Type-safe: Clear semantic meaning of each gradient</li>
<li>Refactoring-safe: Field access is more robust than tuple unpacking</li>
<li>Documentation: Type name itself documents the operation</li>
<li>Extensible: Easy to add new gradient container types</li>
</ul>
<h2 id="2-dtype-dispatch-pattern">2. DType Dispatch Pattern</h2>
<h3 id="purpose_1">Purpose</h3>
<p>Eliminates 40+ lines of repetitive dtype branching code by using compile-time specialized operations
with runtime dispatch. Instead of writing separate code paths for each dtype, write a single operation
and use dispatcher functions to handle runtime dtype selection.</p>
<h3 id="reduction-in-code-size">Reduction in Code Size</h3>
<ul>
<li><strong>Before</strong>: 500+ lines of dtype-specific code</li>
<li><strong>After</strong>: 100 lines with dispatch helpers</li>
<li><strong>Reduction</strong>: 80% fewer lines of code</li>
</ul>
<h3 id="location_1">Location</h3>
<p><code>shared/core/dtype_dispatch.mojo</code></p>
<h3 id="core-concepts">Core Concepts</h3>
<p><strong>elementwise_unary[dtype, op]</strong> - Compile-time specialized unary operation
<strong>elementwise_binary[dtype, op]</strong> - Compile-time specialized binary operation
<strong>elementwise_scalar[dtype, op]</strong> - Compile-time specialized scalar operation</p>
<p><strong>dispatch_unary[op]</strong> - Runtime dispatch to unary operation
<strong>dispatch_binary[op]</strong> - Runtime dispatch to binary operation
<strong>dispatch_scalar[op]</strong> - Runtime dispatch to scalar operation</p>
<p><strong>dispatch_float_unary[op]</strong> - Runtime dispatch for float-only unary operation
<strong>dispatch_float_binary[op]</strong> - Runtime dispatch for float-only binary operation
<strong>dispatch_float_scalar[op]</strong> - Runtime dispatch for float-only scalar operation</p>
<h3 id="supported-dtypes">Supported Dtypes</h3>
<ul>
<li>Float types: float16, float32, float64</li>
<li>Integer types: int8, int16, int32, int64</li>
<li>Unsigned types: uint8, uint16, uint32, uint64</li>
</ul>
<h3 id="usage-example-unary-operation">Usage Example: Unary Operation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Step 1: Define the operation as a generic function</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">fn</span><span class="w"> </span><span class="nf">relu_op</span><span class="p">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nb">DType</span><span class="p">](</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;ReLU activation: max(0, x)&quot;&quot;&quot;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># Step 2: Dispatch to compile-time specialized version (works for any dtype)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="k">fn</span><span class="w"> </span><span class="nf">relu</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">:</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch_unary</span><span class="p">[</span><span class="n">relu_op</span><span class="p">](</span><span class="n">tensor</span><span class="p">)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="c1"># Usage:</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="k">var</span><span class="w"> </span><span class="nv">x_f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full</span><span class="p">(</span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">](</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nb">DType</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="k">var</span><span class="w"> </span><span class="nv">x_i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full</span><span class="p">(</span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">](</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nb">DType</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="k">var</span><span class="w"> </span><span class="nv">result_f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">relu</span><span class="p">(</span><span class="n">x_f32</span><span class="p">)</span><span class="w">  </span><span class="c1"># Works!</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="k">var</span><span class="w"> </span><span class="nv">result_i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">relu</span><span class="p">(</span><span class="n">x_i32</span><span class="p">)</span><span class="w">  </span><span class="c1"># Works!</span>
</code></pre></div>
<h3 id="usage-example-binary-operation_1">Usage Example: Binary Operation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Step 1: Define operation for two tensors</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">fn</span><span class="w"> </span><span class="nf">add_op</span><span class="p">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nb">DType</span><span class="p">](</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1"># Step 2: Use dispatch_binary for runtime dtype checking</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="k">fn</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch_binary</span><span class="p">[</span><span class="n">add_op</span><span class="p">](</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="c1"># Usage:</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">var</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full</span><span class="p">(</span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">](</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="nb">DType</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="k">var</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full</span><span class="p">(</span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">](</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="nb">DType</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="k">var</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</code></pre></div>
<h3 id="usage-example-scalar-operation">Usage Example: Scalar Operation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Step 1: Define operation between tensor and scalar</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">fn</span><span class="w"> </span><span class="nf">mul_op</span><span class="p">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nb">DType</span><span class="p">](</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1"># Step 2: Use dispatch_scalar for tensor-scalar operations</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">fn</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">scalar</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch_scalar</span><span class="p">[</span><span class="n">mul_op</span><span class="p">](</span><span class="n">tensor</span><span class="p">,</span><span class="w"> </span><span class="n">scalar</span><span class="p">)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="c1"># Usage:</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="k">var</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full</span><span class="p">(</span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">](</span><span class="mi">5</span><span class="p">,),</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="nb">DType</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="k">var</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mf">3.5</span><span class="p">)</span><span class="w">  </span><span class="c1"># Scalar automatically converted to float32</span>
</code></pre></div>
<h3 id="usage-example-float-only-operation">Usage Example: Float-Only Operation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># For operations that require floating-point types (exp, log, etc.)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">fn</span><span class="w"> </span><span class="nf">sigmoid_op</span><span class="p">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nb">DType</span><span class="p">](</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Sigmoid activation: 1 / (1 + exp(-x))</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="s2">    Note: Only works with float types</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">exp_neg_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">one</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">exp_neg_x</span><span class="p">)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="c1"># Step 2: Use dispatch_float_unary for float-only operations</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="k">fn</span><span class="w"> </span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">:</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">dispatch_float_unary</span><span class="p">[</span><span class="n">sigmoid_op</span><span class="p">](</span><span class="n">tensor</span><span class="p">)</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="c1"># Usage:</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="k">var</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full</span><span class="p">(</span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">](</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="nb">DType</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="k">var</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">  </span><span class="c1"># Works for float32</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="c1"># This would raise an error at runtime:</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="k">var</span><span class="w"> </span><span class="nv">x_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full</span><span class="p">(</span><span class="nb">List</span><span class="p">[</span><span class="nb">Int</span><span class="p">](</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nb">DType</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">result_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x_int</span><span class="p">)</span><span class="w">  </span><span class="c1"># Error: operation only supports float16/32/64</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="k">except</span><span class="p">:</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot apply sigmoid to integer tensor&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="error-handling">Error Handling</h3>
<p>Dispatch functions provide descriptive error messages that include:</p>
<ul>
<li>Which function failed (dispatch_unary, dispatch_binary, etc.)</li>
<li>Which dtype was unsupported</li>
<li>Expected dtype family (all, float-only, etc.)</li>
</ul>
<h3 id="when-to-use_1">When to Use</h3>
<ul>
<li><strong>dispatch_unary</strong> - For operations that work on any supported dtype</li>
<li><strong>dispatch_binary</strong> - For element-wise binary operations on matching dtypes</li>
<li><strong>dispatch_scalar</strong> - For operations between tensor and scalar</li>
<li><strong>dispatch_float_unary</strong> - For float-only operations (exp, log, sigmoid, etc.)</li>
<li><strong>dispatch_float_binary</strong> - For float-only binary operations</li>
<li><strong>dispatch_float_scalar</strong> - For float-only scalar operations</li>
</ul>
<h3 id="benefits_1">Benefits</h3>
<ul>
<li>Code reduction: 80% fewer lines of dtype-specific code</li>
<li>Single source of truth: One implementation for all dtypes</li>
<li>Compile-time optimization: Zero runtime overhead vs hand-written branches</li>
<li>Easy maintenance: Add new operations without dtype repetition</li>
<li>Type safety: Compile-time specialization catches type errors early</li>
</ul>
<h2 id="3-constants-pattern">3. Constants Pattern</h2>
<h3 id="purpose_2">Purpose</h3>
<p>Centralizes mathematical and numerical constants used across the codebase in dedicated modules.
This prevents magic number proliferation and ensures consistency across all uses.</p>
<h3 id="module-organization">Module Organization</h3>
<h4 id="math-constants">Math Constants</h4>
<p><strong>Location</strong>: <code>shared/core/math_constants.mojo</code></p>
<p>Contains mathematical constants used in activation functions, initializers, and elementwise operations.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Pi and related constants</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">comptime</span><span class="w"> </span><span class="n">PI</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.14159265358979323846</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1"># Square roots</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">comptime</span><span class="w"> </span><span class="n">SQRT_2</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.4142135623730951</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">comptime</span><span class="w"> </span><span class="n">SQRT_2_OVER_PI</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.7978845608028654</span><span class="w">  </span><span class="c1"># sqrt(2/pi) for GELU</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">comptime</span><span class="w"> </span><span class="n">INV_SQRT_2PI</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.3989422804014327</span><span class="w">  </span><span class="c1"># 1/sqrt(2*pi) for normal dist</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="c1"># GELU activation constants</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="n">comptime</span><span class="w"> </span><span class="n">GELU_COEFF</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.044715</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="c1"># Logarithms</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="n">comptime</span><span class="w"> </span><span class="n">LN2</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.6931471805599453</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="n">comptime</span><span class="w"> </span><span class="n">LN10</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.302585092994046</span>
</code></pre></div>
<h4 id="numerical-constants">Numerical Constants</h4>
<p><strong>Location</strong>: <code>shared/core/numerical_constants.mojo</code></p>
<p>Contains epsilon and threshold values for numerical stability.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Division safety - prevents division by zero</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">comptime</span><span class="w"> </span><span class="n">EPSILON_DIV</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-10</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="c1"># Loss function stability - for log operations in BCE, cross-entropy, etc.</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">comptime</span><span class="w"> </span><span class="n">EPSILON_LOSS</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-7</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="c1"># Normalization stability - for BatchNorm, LayerNorm, GroupNorm, InstanceNorm</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="n">comptime</span><span class="w"> </span><span class="n">EPSILON_NORM</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-5</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="c1"># Gradient safety thresholds</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="n">comptime</span><span class="w"> </span><span class="n">GRADIENT_MAX_NORM</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000.0</span><span class="w">  </span><span class="c1"># Threshold for gradient explosion</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="n">comptime</span><span class="w"> </span><span class="n">GRADIENT_MIN_NORM</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-7</span><span class="w">   </span><span class="c1"># Threshold for gradient vanishing</span>
</code></pre></div>
<h3 id="usage-example-gelu-activation">Usage Example: GELU Activation</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.core.math_constants</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">GELU_COEFF</span><span class="p">,</span><span class="w"> </span><span class="n">SQRT_2_OVER_PI</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">fn</span><span class="w"> </span><span class="nf">gelu_approximate</span><span class="p">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nb">DType</span><span class="p">](</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;GELU approximation using precomputed constants.</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="s2">    GELU(x)  0.5 * x * (1 + tanh(sqrt(2/) * (x + 0.044715 * x))).</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="s2">   &quot;&quot;&quot;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">GELU_COEFF</span><span class="p">)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">sqrt_term</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">SQRT_2_OVER_PI</span><span class="p">)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">x_cubed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt_term</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">coeff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_cubed</span><span class="p">)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">half</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">one</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tanh</span><span class="p">(</span><span class="n">inner</span><span class="p">))</span>
</code></pre></div>
<h3 id="usage-example-numerical-stability">Usage Example: Numerical Stability</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.core.numerical_constants</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">EPSILON_LOSS</span><span class="p">,</span><span class="w"> </span><span class="n">EPSILON_NORM</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">fn</span><span class="w"> </span><span class="nf">cross_entropy_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Float64</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Cross-entropy loss with numerical stability.</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="s2">    Uses EPSILON_LOSS to prevent log(0).</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="c1"># Softmax with stability...</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">log_probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="c1"># Clip to prevent log(0)</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">clipped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clip</span><span class="p">(</span><span class="n">log_probs</span><span class="p">,</span><span class="w"> </span><span class="n">EPSILON_LOSS</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">EPSILON_LOSS</span><span class="p">)</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">    </span><span class="c1"># Compute loss...</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">compute_loss</span><span class="p">(</span><span class="n">clipped</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="k">fn</span><span class="w"> </span><span class="nf">batch_norm_forward</span><span class="p">(</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">    </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="n">weight</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span><span class="n">bias</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span><span class="n">running_mean</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">    </span><span class="n">running_var</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">:</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Batch normalization with numerical stability.</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="s2">    Uses EPSILON_NORM to prevent division by zero.</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">    </span><span class="c1"># Normalize with stability</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">x_norm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">running_mean</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">running_var</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">EPSILON_NORM</span><span class="p">)</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">    </span><span class="c1"># Scale and shift</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_norm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bias</span>
</code></pre></div>
<h3 id="when-to-use_2">When to Use</h3>
<ul>
<li><strong>Use constants pattern</strong> - For any value used in more than one function</li>
<li><strong>Use math_constants.mojo</strong> - For mathematical constants (, 2, etc.)</li>
<li><strong>Use numerical_constants.mojo</strong> - For epsilon and threshold values</li>
<li><strong>Don't use magic numbers</strong> - Hard-coded constants should become aliased constants</li>
<li><strong>Don't create new files</strong> - Add new constants to existing files in the module</li>
</ul>
<h3 id="benefits_2">Benefits</h3>
<ul>
<li>Consistency: Same value used everywhere</li>
<li>Maintainability: Single place to update constants</li>
<li>Documentation: Constant names self-document their purpose</li>
<li>Correctness: Prevents typos in frequently-used values</li>
</ul>
<h2 id="4-utility-module-pattern">4. Utility Module Pattern</h2>
<h3 id="purpose_3">Purpose</h3>
<p>Groups related cross-cutting utilities into dedicated modules. This pattern centralizes functionality
that is used across multiple layers or modules without tight coupling.</p>
<h3 id="location_2">Location</h3>
<p><code>shared/autograd/grad_utils.mojo</code> (example)</p>
<h3 id="pattern-structure">Pattern Structure</h3>
<p>Utility modules contain sets of related functions that:</p>
<ol>
<li>Share a common purpose (e.g., gradient clipping)</li>
<li>Are used across multiple components</li>
<li>Don't belong to a single layer's module</li>
<li>Have clear, specialized responsibilities</li>
</ol>
<h3 id="example-gradient-clipping-utilities">Example: Gradient Clipping Utilities</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">clip_grad_value_</span><span class="p">(</span><span class="n">mut</span><span class="w"> </span><span class="n">grad</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">max_value</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="p">:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Clip each gradient element to [-max_value, max_value].</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="s2">    Args:</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="s2">        grad: The gradient tensor to clip (modified in-place).</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="s2">        max_value: Maximum absolute value allowed.</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="s2">    Examples:</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="s2">        var grad = ones(List[Int](3, 4), DType.float32)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="s2">        clip_grad_value_(grad, max_value=1.0).</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="s2">   &quot;&quot;&quot;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">max_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">        </span><span class="k">raise</span><span class="w"> </span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;max_value must be non-negative&quot;</span><span class="p">)</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">grad</span><span class="o">.</span><span class="n">numel</span><span class="p">()):</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="nv">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grad</span><span class="o">.</span><span class="n">_get_float64</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_value</span><span class="p">:</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">            </span><span class="n">grad</span><span class="o">.</span><span class="n">_set_float64</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">max_value</span><span class="p">)</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="k">elif</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">max_value</span><span class="p">:</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">            </span><span class="n">grad</span><span class="o">.</span><span class="n">_set_float64</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">max_value</span><span class="p">)</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="k">fn</span><span class="w"> </span><span class="nf">clip_grad_norm_</span><span class="p">(</span><span class="n">mut</span><span class="w"> </span><span class="n">grad</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span><span class="w"> </span><span class="n">max_norm</span><span class="p">:</span><span class="w"> </span><span class="nb">Float64</span><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Float64</span><span class="p">:</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Clip gradient if its L2 norm exceeds max_norm.</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="s2">    Args:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="s2">        grad: The gradient tensor to clip (modified in-place).</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="s2">        max_norm: Maximum allowed L2 norm.</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="s2">    Returns:</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="s2">        The original L2 norm of the gradient (before clipping).</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="s2">    Examples:</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="s2">        var grad = full(List[Int](100,), 1.0, DType.float32)</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a><span class="s2">        var norm = clip_grad_norm_(grad, max_norm=1.0)</span>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a><span class="s2">        # norm is approximately sqrt(100) = 10</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="s2">        # grad is scaled by 0.1</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a><span class="w">    </span><span class="c1"># Compute L2 norm</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">sum_sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Float64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">grad</span><span class="o">.</span><span class="n">numel</span><span class="p">()):</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="nv">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grad</span><span class="o">.</span><span class="n">_get_float64</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="w">        </span><span class="n">sum_sq</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">val</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">norm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">sum_sq</span><span class="p">)</span>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a><span class="w">    </span><span class="c1"># Scale if needed</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">norm</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_norm</span><span class="p">:</span>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a><span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="nv">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_norm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">norm</span>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">grad</span><span class="o">.</span><span class="n">numel</span><span class="p">()):</span>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a><span class="w">            </span><span class="k">var</span><span class="w"> </span><span class="nv">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grad</span><span class="o">.</span><span class="n">_get_float64</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a><span class="w">            </span><span class="n">grad</span><span class="o">.</span><span class="n">_set_float64</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">norm</span>
</code></pre></div>
<h3 id="usage-example">Usage Example</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.autograd</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">clip_grad_value_</span><span class="p">,</span><span class="w"> </span><span class="n">clip_grad_norm_</span><span class="p">,</span><span class="w"> </span><span class="n">clip_grad_global_norm_</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="k">fn</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">model</span><span class="p">:</span><span class="w"> </span><span class="n">MyModel</span><span class="p">,</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="n">y</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="n">optimizer</span><span class="p">:</span><span class="w"> </span><span class="n">SGD</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">)</span><span class="w"> </span><span class="n">raises</span><span class="p">:</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Single training step with gradient clipping.&quot;&quot;&quot;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="c1"># Forward pass</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">logits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">loss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="c1"># Backward pass</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="c1"># Clip gradients to prevent explosion</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="n">grad</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">grads</span><span class="p">:</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">        </span><span class="n">clip_grad_value_</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="w"> </span><span class="n">max_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">        </span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="w"> </span><span class="n">max_norm</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">    </span><span class="c1"># Update parameters</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">    </span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">grads</span><span class="p">)</span>
</code></pre></div>
<h3 id="common-utility-modules">Common Utility Modules</h3>
<table>
<thead>
<tr>
<th>Module</th>
<th>Purpose</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>grad_utils.mojo</code></td>
<td>Gradient clipping and statistics</td>
<td>clip_grad_value_, clip_grad_norm_</td>
</tr>
<tr>
<td><code>dtype_utils.mojo</code></td>
<td>Dtype-related utilities</td>
<td>dtype conversion helpers</td>
</tr>
<tr>
<td><code>math_utils.mojo</code></td>
<td>Mathematical utilities</td>
<td>Various math operations</td>
</tr>
<tr>
<td><code>tensor_utils.mojo</code></td>
<td>Tensor operations</td>
<td>Shape validation, broadcasting</td>
</tr>
</tbody>
</table>
<h3 id="when-to-use_3">When to Use</h3>
<ul>
<li><strong>Create utility module</strong> - For functions used across 3+ modules</li>
<li><strong>Use in-module helper</strong> - For functions used in only 1-2 modules</li>
<li><strong>Group by concern</strong> - Utilities that share purpose go in same module</li>
<li><strong>Clear naming</strong> - End with <code>_</code> for in-place operations (e.g., <code>clip_grad_value_</code>)</li>
<li><strong>Don't mix concerns</strong> - Don't combine math utilities with gradient utilities</li>
</ul>
<h3 id="benefits_3">Benefits</h3>
<ul>
<li>Centralized functionality: Single source of truth for shared operations</li>
<li>No circular dependencies: Utilities don't depend on layer modules</li>
<li>Reusability: Easy to reuse across different components</li>
<li>Testability: Utilities can be tested independently</li>
<li>Documentation: Clear purpose from module organization</li>
</ul>
<h2 id="integration-example-complete-backward-pass">Integration Example: Complete Backward Pass</h2>
<p>This example shows how all four consolidation patterns work together in a complete backward pass:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.core.gradient_types</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">GradientTriple</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.core.dtype_dispatch</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">dispatch_binary</span><span class="p">,</span><span class="w"> </span><span class="n">dispatch_unary</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.core.numerical_constants</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">EPSILON_LOSS</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.autograd.grad_utils</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">clip_grad_norm_</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="k">fn</span><span class="w"> </span><span class="nf">linear_backward</span><span class="p">(</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="n">grad_output</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span><span class="p">,</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="n">weights</span><span class="p">:</span><span class="w"> </span><span class="n">ExTensor</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">GradientTriple</span><span class="p">:</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="s2">&quot;&quot;&quot;Linear layer backward pass demonstrating all consolidation patterns.</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="s2">    Uses:</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="s2">    1. GradientTriple - Returns structured gradient container</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="s2">    2. dtype_dispatch - Handles arbitrary dtypes</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="s2">    3. Constants - Uses EPSILON_LOSS for stability</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="s2">    4. grad_utils - Clips gradients by norm</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="c1"># Compute gradients using dispatch pattern (avoids dtype branching)</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">matmul_op</span><span class="p">[</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nb">DType</span><span class="p">](</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Scalar</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="c1"># Simplified for example</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">    </span><span class="c1"># grad_input = grad_output @ weights.T</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dispatch_binary</span><span class="p">[</span><span class="n">matmul_op</span><span class="p">](</span><span class="n">grad_output</span><span class="p">,</span><span class="w"> </span><span class="n">weights</span><span class="p">)</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">    </span><span class="c1"># grad_weights = x.T @ grad_output</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dispatch_binary</span><span class="p">[</span><span class="n">matmul_op</span><span class="p">](</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">grad_output</span><span class="p">)</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">    </span><span class="c1"># grad_bias = sum(grad_output)</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="nv">grad_bias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">grad_output</span><span class="p">)</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">    </span><span class="c1"># Apply gradient clipping with stability constant</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">    </span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">grad_input</span><span class="p">,</span><span class="w"> </span><span class="n">max_norm</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="w">    </span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">grad_weights</span><span class="p">,</span><span class="w"> </span><span class="n">max_norm</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="w">    </span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">grad_bias</span><span class="p">,</span><span class="w"> </span><span class="n">max_norm</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="w">    </span><span class="c1"># Return using GradientTriple pattern</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">GradientTriple</span><span class="p">(</span><span class="n">grad_input</span><span class="p">,</span><span class="w"> </span><span class="n">grad_weights</span><span class="p">,</span><span class="w"> </span><span class="n">grad_bias</span><span class="p">)</span>
</code></pre></div>
<h2 id="summary-table">Summary Table</h2>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Purpose</th>
<th>Location</th>
<th>Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gradient Result</td>
<td>Type-safe gradient containers</td>
<td><code>shared/core/gradient_types.mojo</code></td>
<td>Clear semantics, refactoring-safe</td>
</tr>
<tr>
<td>DType Dispatch</td>
<td>Compile-time specialization</td>
<td><code>shared/core/dtype_dispatch.mojo</code></td>
<td>80% code reduction</td>
</tr>
<tr>
<td>Constants</td>
<td>Centralized values</td>
<td><code>shared/core/math_constants.mojo</code>, <code>shared/core/numerical_constants.mojo</code></td>
<td>Consistency, maintainability</td>
</tr>
<tr>
<td>Utility Module</td>
<td>Shared functionality</td>
<td><code>shared/autograd/grad_utils.mojo</code>, etc.</td>
<td>No circular deps, reusability</td>
</tr>
</tbody>
</table>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Always use GradientPair/Triple/Quad</strong> - Never return naked tuples for gradients</li>
<li><strong>Always use dispatch helpers</strong> - Never write dtype branching code manually</li>
<li><strong>Always centralize constants</strong> - No magic numbers in implementation code</li>
<li><strong>Always create utility modules</strong> - For functions used across 3+ modules</li>
<li><strong>Document consolidation patterns</strong> - In module docstrings, not inline comments</li>
<li><strong>Keep patterns pure</strong> - Don't mix unrelated utilities in one module</li>
<li><strong>Reuse existing patterns</strong> - Check for existing consolidated code before creating new</li>
</ol>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../backward-pass-catalog/">Backward Pass Catalog</a></li>
<li><a href="../mojo-test-failure-patterns/">Mojo Test Failure Patterns</a></li>
<li><a href="../skills-architecture/">Skills Architecture</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>