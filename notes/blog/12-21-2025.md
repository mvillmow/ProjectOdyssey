# 12-21-2025: End of the Justfile?

So, i've been trying to get justfile to do what I want, but it just is not as flexible as makefiles when running a developer interface.

For example, I'd like to have the following combinations:

`just compile.release` - which compiles the code in release mode
`just compile.debug` - which compiles the code in debug mode
`just install.release` - which installs release mode
`just install.release.asan` - which installs the address sanitizer in release mode

etc...

The basic pattern is <base command>[.<modifier>]+, with sane defaults, so that `just compile.asan` is actually an address sanitizer build for debug mode.

This allows a very easy to use interface with sparse options. The problem is that justfile doesn't have suffix matching like makefile does, so I have to list out each option in the justfile. This causes a lot of duplication, which violates the DRY principle. Especially when cross compilation builds and multiple address sanitizers and debug modes, the matrix actually gets pretty complex. There are also combinations like thread sanitizer and address sanitizer that are incompatible and build modies that are incompatible, so its actually a very sparse multi-dimensional tensor of options. The dimensions are:

Compilation modes: O0, O1, debug, etc...
Sanitizer options: asan, tsan, etc..
Profiling options: profile on, profile off
Platform: windows, mac, linux, etc...
Architecture: x86, arm, powerpc, riscv, etc...

So the full matrix is fairly complex, and getting it right in justfile is a lot of code duplication, so I'm going to move to makefiles, since that is the only system I know that can handle this correctly. I've used it internally at AMD, NVidia, Oxmiq Labs, and my internal projects to great success, so will code it up here also.

The file ends up looking something like this:

```makefile
# Simplified Project Makefile
# Public targets: compile, test, install, help
# Modifiers are appended as suffixes (e.g. .asan, .native, .release)

# -----------------------------------------------------------------------------
# Configuration
# -----------------------------------------------------------------------------

NPROC ?= $(shell nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
PREFIX ?= /usr/local

BUILD_ROOT ?= build
BUILD_SUBDIR ?= default
BUILD_DIR := $(BUILD_ROOT)/$(BUILD_SUBDIR)

CMAKE_BUILD_TYPE ?= Debug
BUILD_FLAGS ?=

# Placeholder flags
BUILD_FLAGS_debug   := -O0 -g -D_DEBUG
BUILD_FLAGS_release := -O3 -DNDEBUG
BUILD_FLAGS_asan    := -fsanitize=address
BUILD_FLAGS_ubsan   := -fsanitize=undefined
BUILD_FLAGS_lsan    := -fsanitize=leak
BUILD_FLAGS_tsan    := -fsanitize=thread
BUILD_FLAGS_msan    := -fsanitize=memory

# Docker vs native (placeholder behavior)
ifeq ($(NATIVE),1)
	DOCKER_PREFIX :=
else
	DOCKER_PREFIX := echo "[docker exec]"
endif

# -----------------------------------------------------------------------------
# Internal helpers
# -----------------------------------------------------------------------------

$(BUILD_DIR):
	@echo "Creating build directory: $(BUILD_DIR)"
	@mkdir -p $(BUILD_DIR)

# -----------------------------------------------------------------------------
# Public targets (ONLY these)
# -----------------------------------------------------------------------------

.PHONY: compile
compile: $(BUILD_DIR)
	@echo ">>> PLACEHOLDER: compile"
	@echo " - Build dir: $(BUILD_DIR)"
	@echo " - CMAKE_BUILD_TYPE: $(CMAKE_BUILD_TYPE)"
	@echo " - BUILD_FLAGS: $(BUILD_FLAGS)"
	@echo " # Example:"
	@echo " #   cmake -S . -B $(BUILD_DIR) -DCMAKE_BUILD_TYPE=$(CMAKE_BUILD_TYPE)"
	@echo " #   cmake --build $(BUILD_DIR) -j$(NPROC)"

.PHONY: test
test: compile
	@echo ">>> PLACEHOLDER: test"
	@echo " - Using build dir: $(BUILD_DIR)"
	@echo " # Example:"
	@echo " #   cd $(BUILD_DIR) && ctest --output-on-failure -j$(NPROC)"

.PHONY: install
install: compile
	@echo ">>> PLACEHOLDER: install"
	@echo " - Prefix: $(PREFIX)"
	@echo " # Example:"
	@echo " #   cmake --install $(BUILD_DIR) --prefix $(PREFIX)"

# -----------------------------------------------------------------------------
# Modifier patterns (integrated, unchanged in spirit)
# -----------------------------------------------------------------------------

# Native execution
%.native:
	@$(MAKE) $* NATIVE=1

# Sanitizers
%.asan:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) $(BUILD_FLAGS_asan)" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.ubsan:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) $(BUILD_FLAGS_ubsan)" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.lsan:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) $(BUILD_FLAGS_lsan)" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.tsan:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) $(BUILD_FLAGS_tsan)" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.msan:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) $(BUILD_FLAGS_msan)" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

# Feature flags
%.grpc:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) -DENABLE_GRPC=ON" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.coverage:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) -DENABLE_COVERAGE=ON" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.profile:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) -DENABLE_PROFILING=ON" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.fuzz:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) -DENABLE_FUZZING=ON" \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

# Build type selectors
%.debug:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) $(BUILD_FLAGS_debug)" \
		CMAKE_BUILD_TYPE=Debug \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

%.release:
	@$(MAKE) $* \
		BUILD_FLAGS="$(BUILD_FLAGS) $(BUILD_FLAGS_release)" \
		CMAKE_BUILD_TYPE=Release \
		BUILD_SUBDIR="$(BUILD_SUBDIR)$(suffix $@)"

# -----------------------------------------------------------------------------
# Help
# -----------------------------------------------------------------------------

.PHONY: help
help:
	@echo ""
	@echo "Simplified Makefile (baseline targets only)"
	@echo ""
	@echo "Public targets:"
	@echo "  make compile"
	@echo "  make test"
	@echo "  make install"
	@echo ""
	@echo "Modifiers (append to any target):"
	@echo "  .debug        Debug build (default)"
	@echo "  .release      Release build"
	@echo "  .asan         AddressSanitizer"
	@echo "  .ubsan        UndefinedBehaviorSanitizer"
	@echo "  .tsan         ThreadSanitizer"
	@echo "  .lsan         LeakSanitizer"
	@echo "  .msan         MemorySanitizer"
	@echo "  .grpc         Enable gRPC"
	@echo "  .coverage     Enable coverage"
	@echo "  .profile      Enable profiling"
	@echo "  .fuzz         Enable fuzzing"
	@echo "  .native       Run on host instead of Docker"
	@echo ""
	@echo "Examples:"
	@echo "  make compile"
	@echo "  make test.asan"
	@echo "  make compile.release.native"
	@echo "  make install.debug.grpc"
	@echo ""
```

This makes handling complex build sets very efficiently and makes it very maintainable.
